name: ðŸš€ AI Excel æ™ºèƒ½åˆ†æžå·¥å…· - è‡ªåŠ¨åŒ–éƒ¨ç½²

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.9'
  
jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    name: ðŸ” ä»£ç æµ‹è¯•ä¸Žè´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸ” ä»£ç è¯­æ³•æ£€æŸ¥
      run: |
        echo "=== æ£€æŸ¥Pythonè¯­æ³• ==="
        python -m py_compile app_enhanced_multiuser.py
        python -m py_compile user_session_manager.py
        python -m py_compile excel_utils.py
        python -m py_compile config_multiuser.py
        python -m py_compile generate_ai_analysis_package.py
        python -m py_compile run_multiuser.py
        echo "âœ… æ‰€æœ‰Pythonæ–‡ä»¶è¯­æ³•æ£€æŸ¥é€šè¿‡"
        
    - name: ðŸ“‹ æ£€æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "=== æ£€æŸ¥é¡¹ç›®æ–‡ä»¶å®Œæ•´æ€§ ==="
        required_files=(
          "app_enhanced_multiuser.py"
          "user_session_manager.py"
          "excel_utils.py"
          "config_multiuser.py"
          "generate_ai_analysis_package.py"
          "run_multiuser.py"
          "requirements.txt"
          "README.md"
          "USER_GUIDE.md"
          "DEVELOPER_GUIDE.md"
        )
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰å¿…è¦æ–‡ä»¶æ£€æŸ¥å®Œæ¯•"

  # Dockeræž„å»ºæµ‹è¯•
  build:
    name: ðŸ³ Dockeræž„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ³ è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ”¨ æž„å»ºDockeré•œåƒ
      run: |
        cat > Dockerfile << 'EOF'
        FROM python:3.9-slim
        
        WORKDIR /app
        
        # å®‰è£…ç³»ç»Ÿä¾èµ–
        RUN apt-get update && apt-get install -y \
            gcc \
            && rm -rf /var/lib/apt/lists/*
        
        # å¤åˆ¶å¹¶å®‰è£…Pythonä¾èµ–
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        
        # å¤åˆ¶åº”ç”¨æ–‡ä»¶
        COPY . .
        
        # åˆ›å»ºå¿…è¦ç›®å½•
        RUN mkdir -p user_uploads
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV STREAMLIT_SERVER_PORT=8501
        ENV STREAMLIT_SERVER_ADDRESS=0.0.0.0
        ENV STREAMLIT_SERVER_HEADLESS=true
        ENV STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
        
        # æš´éœ²ç«¯å£
        EXPOSE 8501
        
        # å¥åº·æ£€æŸ¥
        HEALTHCHECK CMD curl --fail http://localhost:8501/_stcore/health
        
        # å¯åŠ¨å‘½ä»¤
        CMD ["streamlit", "run", "app_enhanced_multiuser.py", "--server.port=8501", "--server.address=0.0.0.0"]
        EOF
        
        docker build -t ai-excel-tool:test .
        echo "âœ… Dockeré•œåƒæž„å»ºæˆåŠŸ"

  # Streamlit Cloudéƒ¨ç½²å‡†å¤‡
  prepare-streamlit-cloud:
    name: â˜ï¸ Streamlit Cloudéƒ¨ç½²å‡†å¤‡
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ“ åˆ›å»ºStreamlité…ç½®
      run: |
        mkdir -p .streamlit
        
        cat > .streamlit/config.toml << 'EOF'
        [server]
        headless = true
        port = 8501
        enableCORS = false
        enableXsrfProtection = false
        
        [browser]
        gatherUsageStats = false
        
        [theme]
        primaryColor = "#FF6B6B"
        backgroundColor = "#FFFFFF"
        secondaryBackgroundColor = "#F0F2F6"
        textColor = "#262730"
        EOF
        
        cat > .streamlit/secrets.toml << 'EOF'
        # åœ¨Streamlit Cloudä¸­é…ç½®ä»¥ä¸‹å¯†é’¥ï¼š
        # OPENAI_API_KEY = "your-openai-api-key"
        # æˆ–è€…ç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ä¸­æ‰‹åŠ¨è¾“å…¥
        EOF
        
        echo "âœ… Streamlité…ç½®æ–‡ä»¶å·²åˆ›å»º"
        
    - name: ðŸ“„ åˆ›å»ºéƒ¨ç½²è¯´æ˜Žæ–‡æ¡£
      run: |
        cat > DEPLOYMENT.md << 'EOF'
        # ðŸš€ éƒ¨ç½²æŒ‡å—
        
        ## Streamlit Cloudéƒ¨ç½²ï¼ˆæŽ¨èï¼‰
        
        ### 1. å‡†å¤‡å·¥ä½œ
        1. Forkè¿™ä¸ªä»“åº“åˆ°æ‚¨çš„GitHubè´¦æˆ·
        2. è®¿é—® [share.streamlit.io](https://share.streamlit.io)
        3. ä½¿ç”¨GitHubè´¦æˆ·ç™»å½•
        
        ### 2. éƒ¨ç½²æ­¥éª¤
        1. ç‚¹å‡» "New app"
        2. é€‰æ‹©æ‚¨forkçš„ä»“åº“
        3. ä¸»æ–‡ä»¶è·¯å¾„è®¾ç½®ä¸ºï¼š`app_enhanced_multiuser.py`
        4. ç‚¹å‡» "Deploy!"
        
        ### 3. çŽ¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰
        åœ¨Streamlit Cloudçš„Appè®¾ç½®ä¸­ï¼Œå¯ä»¥é…ç½®ä»¥ä¸‹çŽ¯å¢ƒå˜é‡ï¼š
        ```
        OPENAI_API_KEY=your-openai-api-key
        ```
        
        ## Dockeréƒ¨ç½²
        
        ### æœ¬åœ°Dockerè¿è¡Œ
        ```bash
        # æž„å»ºé•œåƒ
        docker build -t ai-excel-tool .
        
        # è¿è¡Œå®¹å™¨
        docker run -p 8501:8501 \
          -v $(pwd)/user_uploads:/app/user_uploads \
          -e OPENAI_API_KEY=your-api-key \
          ai-excel-tool
        ```
        
        ### Docker Compose
        ```yaml
        version: '3.8'
        services:
          ai-excel-tool:
            build: .
            ports:
              - "8501:8501"
            volumes:
              - ./user_uploads:/app/user_uploads
            environment:
              - OPENAI_API_KEY=${OPENAI_API_KEY}
            restart: unless-stopped
        ```
        
        ## äº‘å¹³å°éƒ¨ç½²
        
        ### Railway
        1. è¿žæŽ¥GitHubä»“åº“åˆ°Railway
        2. è®¾ç½®çŽ¯å¢ƒå˜é‡
        3. è‡ªåŠ¨éƒ¨ç½²
        
        ### Render
        1. è¿žæŽ¥GitHubä»“åº“
        2. é€‰æ‹©Web Service
        3. å¯åŠ¨å‘½ä»¤ï¼š`streamlit run app_enhanced_multiuser.py --server.port $PORT --server.address 0.0.0.0`
        
        ### Heroku
        éœ€è¦æ·»åŠ ä»¥ä¸‹æ–‡ä»¶ï¼š
        
        **Procfile:**
        ```
        web: streamlit run app_enhanced_multiuser.py --server.port $PORT --server.address 0.0.0.0
        ```
        
        **runtime.txt:**
        ```
        python-3.9.18
        ```
        EOF
        
        echo "âœ… éƒ¨ç½²è¯´æ˜Žæ–‡æ¡£å·²åˆ›å»º"

    - name: ðŸ“¤ ä¸Šä¼ éƒ¨ç½²é…ç½®
      uses: actions/upload-artifact@v3
      with:
        name: deployment-configs
        path: |
          .streamlit/
          DEPLOYMENT.md
          Dockerfile

  # å‘å¸ƒRelease
  release:
    name: ðŸ“¦ åˆ›å»ºReleaseç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: [test, build, prepare-streamlit-cloud]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ·ï¸ ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        # åŸºäºŽæ—¥æœŸå’Œcommitç”Ÿæˆç‰ˆæœ¬å·
        VERSION="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ç”Ÿæˆç‰ˆæœ¬å·: $VERSION"
        
    - name: ðŸ“¦ åˆ›å»ºReleaseåŒ…
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        mkdir -p release-package
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶
        cp -r \
          app_enhanced_multiuser.py \
          user_session_manager.py \
          excel_utils.py \
          config_multiuser.py \
          generate_ai_analysis_package.py \
          run_multiuser.py \
          requirements.txt \
          README.md \
          USER_GUIDE.md \
          DEVELOPER_GUIDE.md \
          .github \
          release-package/
          
        # åˆ›å»ºå®‰è£…è„šæœ¬
        cat > release-package/install.sh << 'EOF'
        #!/bin/bash
        echo "ðŸš€ AI Excel æ™ºèƒ½åˆ†æžå·¥å…· - å®‰è£…è„šæœ¬"
        echo "=================================="
        
        # æ£€æŸ¥Pythonç‰ˆæœ¬
        python_version=$(python3 --version 2>&1 | awk '{print $2}' | cut -d. -f1-2)
        echo "æ£€æµ‹åˆ°Pythonç‰ˆæœ¬: $python_version"
        
        if [[ $(echo "$python_version >= 3.8" | bc -l) -eq 1 ]]; then
            echo "âœ… Pythonç‰ˆæœ¬ç¬¦åˆè¦æ±‚"
        else
            echo "âŒ Pythonç‰ˆæœ¬éœ€è¦ >= 3.8"
            exit 1
        fi
        
        # å®‰è£…ä¾èµ–
        echo "ðŸ“¦ å®‰è£…ä¾èµ–åŒ…..."
        pip3 install -r requirements.txt
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        cat > start.sh << 'EOL'
        #!/bin/bash
        echo "ðŸš€ å¯åŠ¨AI Excelæ™ºèƒ½åˆ†æžå·¥å…·..."
        python3 run_multiuser.py
        EOL
        chmod +x start.sh
        
        echo "âœ… å®‰è£…å®Œæˆï¼"
        echo "ðŸ’¡ ä½¿ç”¨ ./start.sh å¯åŠ¨åº”ç”¨"
        EOF
        chmod +x release-package/install.sh
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        cd release-package
        tar -czf ../ai-excel-tool-${{ steps.version.outputs.version }}.tar.gz .
        cd ..
        
    - name: ðŸŽ‰ åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: AI Excel æ™ºèƒ½åˆ†æžå·¥å…· ${{ steps.version.outputs.version }}
        body: |
          ## ðŸš€ AI Excel æ™ºèƒ½åˆ†æžå·¥å…· - æ–°ç‰ˆæœ¬å‘å¸ƒ
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          - ðŸ¤– AIæ™ºèƒ½åˆ†æž - æ·±åº¦ä¸šåŠ¡ç†è§£ã€è‡ªç„¶è¯­è¨€äº¤äº’
          - ðŸ” å¤šç”¨æˆ·æ”¯æŒ - å®Œå…¨æ•°æ®éš”ç¦»ã€ä¼šè¯ç®¡ç†  
          - ðŸ’» ä»£ç æ‰§è¡ŒçŽ¯å¢ƒ - å®‰å…¨éš”ç¦»ã€æ–‡ä»¶è‡ªåŠ¨æ‹¦æˆª
          - ðŸ“ æ™ºèƒ½æ–‡ä»¶ç®¡ç† - è‡ªåŠ¨æ‹¦æˆªä¿å­˜ã€åˆ†ç±»ä¸‹è½½
          
          ### ðŸ“¦ å®‰è£…æ–¹å¼
          
          #### å¿«é€Ÿå®‰è£…
          ```bash
          # ä¸‹è½½å¹¶è§£åŽ‹
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/ai-excel-tool-${{ steps.version.outputs.version }}.tar.gz
          tar -xzf ai-excel-tool-${{ steps.version.outputs.version }}.tar.gz
          cd ai-excel-tool-*
          
          # è¿è¡Œå®‰è£…è„šæœ¬
          chmod +x install.sh
          ./install.sh
          
          # å¯åŠ¨åº”ç”¨
          ./start.sh
          ```
          
          #### Streamlit Cloudéƒ¨ç½²
          1. Forkè¿™ä¸ªä»“åº“
          2. è®¿é—® [share.streamlit.io](https://share.streamlit.io)
          3. é€‰æ‹©ä»“åº“å’Œ `app_enhanced_multiuser.py` æ–‡ä»¶
          4. ç‚¹å‡»Deployï¼
          
          ### ðŸ“š æ–‡æ¡£
          - [ç”¨æˆ·æŒ‡å—](USER_GUIDE.md)
          - [å¼€å‘è€…æŒ‡å—](DEVELOPER_GUIDE.md)
          - [éƒ¨ç½²æŒ‡å—](DEPLOYMENT.md)
          
          ### ðŸ†• æœ¬æ¬¡æ›´æ–°
          - å®Œå–„GitHub Actionsè‡ªåŠ¨åŒ–éƒ¨ç½²
          - ä¼˜åŒ–æ–‡æ¡£ç»“æž„
          - ä¿®å¤å·²çŸ¥é—®é¢˜
          
          ---
          **ðŸ’¡ é¦–æ¬¡ä½¿ç”¨å»ºè®®æŸ¥çœ‹[ç”¨æˆ·æŒ‡å—](USER_GUIDE.md)äº†è§£å®Œæ•´åŠŸèƒ½**
        files: |
          ai-excel-tool-${{ steps.version.outputs.version }}.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥ä»»åŠ¡
  notify:
    name: ðŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [test, build, prepare-streamlit-cloud]
    if: always()
    
    steps:
    - name: ðŸ“Š æ±‡æ€»éƒ¨ç½²çŠ¶æ€
      run: |
        echo "=== ðŸš€ AI Excel æ™ºèƒ½åˆ†æžå·¥å…· - éƒ¨ç½²çŠ¶æ€æ±‡æ€» ==="
        echo "æµ‹è¯•çŠ¶æ€: ${{ needs.test.result }}"
        echo "æž„å»ºçŠ¶æ€: ${{ needs.build.result }}"
        echo "éƒ¨ç½²å‡†å¤‡: ${{ needs.prepare-streamlit-cloud.result }}"
        echo ""
        
        if [[ "${{ needs.test.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
          echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²ï¼"
          echo ""
          echo "ðŸš€ å¿«é€Ÿéƒ¨ç½²åˆ°Streamlit Cloudï¼š"
          echo "1. è®¿é—® https://share.streamlit.io"
          echo "2. è¿žæŽ¥æ­¤GitHubä»“åº“"
          echo "3. ä¸»æ–‡ä»¶è®¾ç½®ä¸º: app_enhanced_multiuser.py"
          echo "4. ç‚¹å‡»Deployï¼"
          echo ""
          echo "ðŸ“¦ æœ¬åœ°éƒ¨ç½²ï¼š"
          echo "1. git clone ${{ github.server_url }}/${{ github.repository }}"
          echo "2. cd AI-Excel-Talk"
          echo "3. pip install -r requirements.txt"
          echo "4. python run_multiuser.py"
        else
          echo "âŒ æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ä¿®å¤é—®é¢˜"
          exit 1
        fi 